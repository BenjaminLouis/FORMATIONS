---
title: 'Analyse de la variance (anova)'
subtitle: "quantitatif ~ f(qualitatif)"
author: "Benjamin Louis"
date: "16/10/2019 (MàJ: `r format(Sys.Date(), '%d/%m/%Y')`)"
output:
  xaringan::moon_reader:
    css: [default, default-fonts, "../static/css/custom.css"]
    lib_dir: libs
    nature:
      highlightStyle: agate
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, echo = FALSE, warning = FALSE, message = FALSE}
htmltools::tagList(rmarkdown::html_dependency_font_awesome())
library(knitr)
library(kableExtra)
library(ggplot2)
library(tibble)
library(readr)
library(tidyr)
library(viridis)
library(dplyr)
```

# Définition et objetif

__Modèle général__ :

.center[

$y_{ij...nr} = \mu + \alpha_{i} + \beta_{j} + ... + \gamma_{n} + ... + \alpha\beta_{ij} + ... + \beta\gamma_{jn} + \epsilon_{ij...nr}$

$\epsilon_{ij...nr} \rightarrow N(0, \sigma^2)~~~~~~cov(\epsilon_{ij...nr},\epsilon_{i'j'...n'r'}) = 0$

]


.small[
+ $\mu$ : intercept
+ $\alpha$, $\beta$, $\gamma$ : variables qualitatives
+ $\alpha_{i}$ : valeur pour la modalité $i$ de la variable associée au paramètre $\alpha$
+ $\alpha\beta$ : interaction entre $\alpha$ et $\beta$
+ $\epsilon$ : erreur résiduelle
]

__Objectif principal__ :

Tester et étudier l'influence de variables qualitatives sur une variable numérique. 

__Hypothèses__ :

.small[
+ Sur les résidus
+ Sur les coefficients : $\alpha_{ref} = 0$ ou $\sum_i\alpha_{i} = 0$ 
]

---

# Exemple

+ Expérimentation en plein champ avec I = 3 variétés différentes de blé et J = 2 types de fongicides

<br/>

+ 54 parcelles : 9 répétitions pour chaque pair de variété et fongicide

<br/>

+ Question : existe t-il des différences de rendement entre les variétés de blé et selon le fongicide utilisé ?

<br/>

+ Model :
.center[

$rendement_{ijr} = \mu + \alpha_{variete = i} + \beta_{fongicide=j} + \alpha\beta_{variete = i,fongicide=j} + \epsilon_{ijr}$

]

---
class: wider

### Estimation par moindres carrés (modèle à 1 facteur !)

.container-grid[
.row[
.col-5[
.small[
```{r eval = FALSE}
# Par défaut dans R
#
#
```
]
]
.col-1[]
.col-5[
.small[
```{r eval = FALSE}
options(contrasts=c("contr.sum","contr.sum"))
# ou
FactoMineR::AovSum()
```
]
]
]
.small[
.row[
.col-5[
+ $\hat{\mu} = \bar{y}_{i=ref}$

+ $\hat{\alpha}_{i=ref} = 0\\\hat{\alpha}_{i \neq ref} =  \bar{y}_{i \neq ref} - \mu$

]
.col-1[]
.col-5[
+ $\hat{\mu} = \bar{y}$

+ $\hat{\alpha}_{i} =  \bar{y}_{i} - \mu$
]
]
]
]

<hr/>

+ $\hat{y}_{ik} = \hat{\mu} + \hat{\alpha}_{i}$ 

+ $e_{ik} = y_{ik} - \hat{y}_{ik}$ 

+ $\hat{\sigma}^2 = \frac{\sum_{ik}\epsilon^2_{ik}}{n - I}$

+ $\hat{\sigma}^2_{\hat{\alpha}_{i} } = \frac{I - 1}{n}\hat{\sigma}^2$

---

# Illustration

.container-grid[
.row[
.col-3[Sepal.Length<sub>ik</sub>]
.col-1[] 
.col-1[]
.col-1[]
.col-1[]
.col-5[]
]]

```{r echo  = FALSE, dpi = 150, fig.asp = 0.65, fig.width = 8, out.width = "90%"}
set.seed(7)
iris %>% 
  mutate(mu = mean(Sepal.Length, na.rm = TRUE),
         rk = as.numeric(Species)) %>% 
  mutate(jitterpoint = rk + rnorm(n(), 0, 0.2)) %>% 
  group_by(Species) %>%   
  mutate(rkmin = 0.99*min(jitterpoint),
         rkmax = 1.01*max(jitterpoint)) %>% 
  mutate(preds = mean(Sepal.Length, na.rm = TRUE)) %>% 
  mutate(alphas = preds - mu,
         res = Sepal.Length - preds) %>% 
  ggplot() +
  aes(x = Species, y = Sepal.Length) +
  geom_jitter(width = 0.4, color = "transparent") +
  geom_point(aes(x = jitterpoint)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 13, face = "bold"),
        axis.text = element_text(size = 11, face = "bold"),
        axis.title.x = element_text(color = "transparent"),
        axis.text.x = element_text(color = "transparent"))
```


---

# Illustration

.container-grid[
.row[
.col-3[Sepal.Length<sub>ik</sub>]
.col-1[= .boxgrey[&mu;]] 
.col-1[]
.col-1[]
.col-1[]
.col-5[]
]]

```{r echo  = FALSE, dpi = 150, fig.asp = 0.65, fig.width = 8, out.width = "90%"}
set.seed(7)
iris %>% 
  mutate(mu = mean(Sepal.Length, na.rm = TRUE),
         rk = as.numeric(Species)) %>% 
  mutate(jitterpoint = rk + rnorm(n(), 0, 0.2)) %>% 
  group_by(Species) %>%   
  mutate(rkmin = 0.99*min(jitterpoint),
         rkmax = 1.01*max(jitterpoint)) %>% 
  mutate(preds = mean(Sepal.Length, na.rm = TRUE)) %>% 
  mutate(alphas = preds - mu,
         res = Sepal.Length - preds) %>% 
  ggplot() +
  aes(x = Species, y = Sepal.Length) +
  geom_jitter(width = 0.4, color = "transparent") +
  geom_point(aes(x = jitterpoint)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 13, face = "bold"),
        axis.text = element_text(size = 11, face = "bold"),
        axis.title.x = element_text(color = "transparent"),
        axis.text.x = element_text(color = "transparent")) +
  
  geom_segment(aes(x = min(rk) - 0.4, xend = max(rk) + 0.4,
                   y = mu, yend = mu), color = "grey", size = 2) +
  geom_label(aes(x = 0.4, y = mu, label = round(mu, 1)), fill = "grey", color = "black",  hjust = -0.3) +
  geom_segment(aes(x = 0.4, xend = 0.43, y = mu, yend = mu), color = "grey")
```


---

# Illustration

.container-grid[
.row[
.col-3[Sepal.Length<sub>ik</sub>]
.col-1[= .boxgrey[&mu;]] 
.col-1[\+ &alpha;<sub>i</sub>]
.col-1[]
.col-1[]
.col-5[, .small[i = {.boxgreen[setosa]|.boxorange[versicolor]|.boxpurple[virginica]}]]
]]

```{r echo  = FALSE, dpi = 150, fig.asp = 0.65, fig.width = 8, out.width = "90%"}
set.seed(7)
iris %>% 
  mutate(mu = mean(Sepal.Length, na.rm = TRUE),
         rk = as.numeric(Species)) %>% 
  mutate(jitterpoint = rk + rnorm(n(), 0, 0.2)) %>% 
  group_by(Species) %>%   
  mutate(rkmin = 0.99*min(jitterpoint),
         rkmax = 1.01*max(jitterpoint)) %>% 
  mutate(preds = mean(Sepal.Length, na.rm = TRUE)) %>% 
  mutate(alphas = preds - mu,
         res = Sepal.Length - preds) %>% 
  ggplot() +
  aes(x = Species, y = Sepal.Length) +
  geom_jitter(width = 0.4, color = "transparent") +
  geom_point(aes(x = jitterpoint)) +
  theme_bw() +
  theme(axis.title = element_text(size = 13, face = "bold"),
        axis.text = element_text(size = 11, face = "bold")) +
  geom_segment(aes(x = min(rk) - 0.4, xend = max(rk) + 0.4,
                   y = mu, yend = mu), color = "grey", size = 2) +
  geom_label(aes(x = 0.4, y = mu, label = round(mu, 1)), fill = "grey", color = "black",  hjust = -0.3) +
  geom_segment(aes(x = 0.4, xend = 0.43, y = mu, yend = mu), color = "grey") +
  aes(color = Species) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +
  guides(color = FALSE, fill = FALSE) +
  geom_segment(aes(x = rkmin, xend = rkmax,
                   y = preds, yend = preds), size = 2) +
  geom_segment(aes(x = rk, xend = rk, y = mu, yend = preds),
               arrow = arrow(length = unit(0.015, "npc"), type = "closed",
                             ends = "both")) +
  geom_text(aes(x = 0.4, y = preds, label = round(preds, 1)), hjust = -0.3) +
  geom_segment(aes(x = 0.4, xend = 0.43, y = preds, yend = preds)) +
  geom_label(aes(x = rk, y = (mu+preds)/2, label = round(alphas,1), fill = Species), color = "white") 
```


---

# Illustration

.container-grid[
.row[
.col-3[Sepal.Length<sub>ik</sub>]
.col-1[= .boxgrey[&mu;]] 
.col-1[\+ &alpha;<sub>i</sub>]
.col-1[\+ &epsilon;<sub>ik</sub>]
.col-1[]
.col-5[, .small[i = {.boxgreen[setosa]|.boxorange[versicolor]|.boxpurple[virginica]}]]
]]

```{r echo  = FALSE, dpi = 150, fig.asp = 0.65, fig.width = 8, out.width = "90%"}
set.seed(7)
iris %>% 
  mutate(mu = mean(Sepal.Length, na.rm = TRUE),
         rk = as.numeric(Species)) %>% 
  mutate(jitterpoint = rk + rnorm(n(), 0, 0.2)) %>%
  group_by(Species) %>%  
  mutate(rkmin = 0.99*min(jitterpoint),
         rkmax = 1.01*max(jitterpoint)) %>% 
  mutate(preds = mean(Sepal.Length, na.rm = TRUE)) %>% 
  mutate(alphas = preds - mu,
         res = Sepal.Length - preds) %>% 
  ggplot() +
  aes(x = Species, y = Sepal.Length) +
  geom_jitter(width = 0.4, color = "transparent") +
  geom_point(aes(x = jitterpoint)) +
  theme_bw() + 
  theme(axis.title = element_text(size = 13, face = "bold"),
        axis.text = element_text(size = 11, face = "bold")) +
  geom_segment(aes(x = min(rk) - 0.4, xend = max(rk) + 0.4,
                   y = mu, yend = mu), color = "grey", size = 2) +
  geom_label(aes(x = 0.4, y = mu, label = round(mu, 1)), fill = "grey", color = "black",  hjust = -0.3) +
  geom_segment(aes(x = 0.4, xend = 0.43, y = mu, yend = mu), color = "grey") +
  aes(color = Species) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +
  guides(color = FALSE, fill = FALSE) +
  geom_segment(aes(x = rkmin, xend = rkmax,
                   y = preds, yend = preds), size = 2) +
  geom_segment(aes(x = rk, xend = rk, y = mu, yend = preds),
               arrow = arrow(length = unit(0.015, "npc"), type = "closed",
                             ends = "both")) +
  geom_text(aes(x = 0.4, y = preds, label = round(preds, 1)), hjust = -0.3) +
  geom_segment(aes(x = 0.4, xend = 0.43, y = preds, yend = preds)) +
  geom_segment(aes(x = jitterpoint, xend = jitterpoint, y = preds, yend = Sepal.Length), color = "black", linetype = "dashed", alpha = 0.5) +
  geom_label(aes(x = rk, y = (mu + preds)/2, label = round(alphas, 1), fill = Species), color = "white")
```

---

# Test de l'effet d'une variable

.big[<i class = "fas fa-arrow-circle-right"></i> La variabilité de]  $y$ .big[entre les modalités de la variable  est elle _significativement_ plus grande que la variabilté résiduelle ?]


####.orange[<i class = "fas fa-exclamation-triangle"></i>] Dans le cas d'un plan équilibré .orange[<i class = "fas fa-exclamation-triangle"></i>] :


$\sum_{ij}\left(y_{ij} - \bar{y}\right)^2~~~~~=~~~~~~~~\frac{n}{I}\sum_{i}\left(\hat{\alpha}_i\right)^2~~~~~~~~~+~~~~~~~~~~~~\sum_{ij}\left(e_{ij}\right)^2$

.small[
.container-grid[
.row[
.col-3[Variabilité totale]
.col-1[=]
.col-3[Variabilité interclasse (_between group_)] 
.col-1[+]
.col-3[Variabilité interclasse (_whithin group_)]
]]
]

.container-grid[
.row[
.col-3[SS<sub>T</sub>]
.col-1[=]
.col-3[SS<sub>F</sub>] 
.col-1[+]
.col-3[SS<sub>R</sub>]
]]


Test : à quel point SS<sub>F</sub> est plus grande que SS<sub>R</sub> ? 
(.small[Plus il y a de groupes/observations, plus les valeurs risques d'être élevées !])

<i class = "fas fa-arrow-circle-right"></i> Il faut normaliser avec les_ __degrés de libertés__ (_df_)!

.pull-left[
$$CM_{F} = \frac{SS_F}{I - 1}$$
]

.pull-right[
$$CM_{R} = \frac{SS_R}{n - (I - 1) - 1}$$
]

---

# Dans R

```{r}
options(contrasts=c("contr.sum","contr.sum"))
mod = lm(Sepal.Length ~ Species, data = iris)
anova(mod)
```

---

# Test de l'effet d'une variable

__Hypothèse__ :

_H<sub>0</sub>_ : $\alpha_i = 0,~~ \forall~~i$, tous les coefficients sont égaux, donc nuls

_H<sub>1</sub>_ : $\exists~~ \alpha_i \neq$ 0, un coefficient au moins n'est pas nul

__Statistique de test__ :

$$F_{obs} = \frac{CM_F}{CM_R}$$

__Sous _H<sub>0</sub>___ :

$$F_{obs} \rightarrow F_{n-I}^{I-1}$$

---

# Test de l'effet d'une variable

.container-grid[
.row[
.col-6[
```{r echo = FALSE, dpi = 150, out.width = "100%", fig.width = 6}
f <- qf(0.95, 6, 8)
d <- df(f, 6, 8)
tibble(
  x = seq(0, 5, 0.001),
  y = df(x = x, 6, 8)
) %>% 
  ggplot() +
  aes(x = x, y = y) +
  geom_line() +
  theme_bw() +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.7)) +
  scale_x_continuous(expand = c(0, 0), limits = c(-0.2, 5.02)) +
  theme(axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(size = 0.5)) +
  annotate("text", x = 3, y = 0.6, label = "Loi~de~F[obs]~sous~H[0]~(F[n-I]^{I-1})", size = 8, parse  = TRUE) +
  geom_segment(aes(x = f, xend = f, y = 0, yend = d)) +
  geom_segment(aes(x = 0, xend = f, y = 0.005, yend = 0.005), color = viridis(3)[1],
               arrow = arrow(ends = "both", type = "closed", length = unit(0.05, "inches"))) +
  geom_segment(aes(x = f, xend = 5, y = 0.005, yend = 0.005), color = viridis(3)[2],
               arrow = arrow(ends = "both", type = "closed", length = unit(0.05, "inches"))) +
  annotate("text", x = 4.1, y = 0.015, label = "Rejet~de~H[0]", size = 4, color = viridis(3)[2], parse = TRUE) +
  annotate("text", x = 1.7, y = 0.015, label = "Acceptation~de~H[0]", size = 4, color = viridis(3)[1], parse = TRUE) +
  annotate("text", x = 4, y = 0.07, label = "alpha", size = 5, color = viridis(3)[2], parse = TRUE) +
  annotate("text", x = 1, y = 0.3, label = "1 - alpha", size = 5, color = viridis(3)[1], parse = TRUE) +
  geom_segment(aes(x = 4, xend = 3.8, y = 0.065, yend = 0.015), color = viridis(3)[2],
               arrow = arrow(ends = "last", type = "closed", length = unit(0.05, "inches"))) 
  
```
]
.col-6[.small[
#### Règle de décision

$F_{obs} < F_{n-I}^{I-1}(1-\alpha) \Rightarrow$ acceptation de $H_0$

$F_{obs} \geq F_{n-I}^{I-1}(1-\alpha) \Rightarrow$ rejet de $H_0$
]
]
]
]

---

# Dans R

```{r}
options(contrasts=c("contr.sum","contr.sum"))
mod = lm(Sepal.Length ~ Species, data = iris)
anova(mod)
```

```{r eval = FALSE}
pf(119.26, 2, 147, lower.tail = FALSE)
```


---

# Exemples avec plus de facteurs

```{r}
library(agricolae)
data(greenhouse)
data <- greenhouse$greenhouse1
mod <- lm(weight ~ variety*method, data = data)
anova(mod)
```

---

## Summary

.small[

Énormément d'information donné par le `summary()` !!!


```{r}
summary(mod)
```
]

---

# Vérification hypothèses

```{r fig.asp = 0.8, fig.align = "center"}
plot(mod, which = 2)
```


---

# Vérification hypothèses



```{r fig.asp = 0.8, fig.align = "center"}
plot(mod, which = 1)
```

---

# Vérification hypothèses


```{r fig.asp = 0.8, fig.align = "center"}
qplot(x = data$variety, y = residuals(mod), geom = "point")
```

---

# Vérification hypothèses


```{r fig.asp = 0.8, fig.align = "center"}
qplot(x = data$method, y = residuals(mod), geom = "point")
```
---

## Tests post-hoc (comparaisons multiples)

```{r}
library(emmeans)
pairs(emmeans(mod, ~method))
```

---

## Tests post-hoc (comparaisons multiples)

.small[
```{r}
pairs(emmeans(mod, ~variety|method))
```
]
---

## .orange[<i class = "fas fa-exclamation-triangle"></i>] p-value !!! 

#### Tableau d'Anova

```{r echo = FALSE}
tibble("x" = "p-value", fongicide = 0.0500205, 'variété' = 6.926e-4, interaction = 0.231347) %>% 
  kable(format = "html", col.names = c("", "fongicide", "variete", "interaction")) %>% 
  kable_styling()
```

.pull-left[
#### Comparaisons fongicides

```{r echo = FALSE}
tibble("x" = "F1-F2", Estimate = 9.81, 'p-value' = 0.0500205) %>% 
  kable(format = "html", col.names = c("", "Estimate", "p-value")) %>% 
  kable_styling()
```
]

.pull-right[
#### Comparaisons variétés

```{r echo = FALSE}
tibble("x" = c("V1-V2", "V1-V3", "V2-V3"), Estimate = c(2.58, 3.36, 0.78), 
       'p-value' =c(0.0284387, 0.0173694, 0.1120579)) %>% 
  kable(format = "html", col.names = c("", "Estimate", "p-value")) %>% 
  kable_styling()
```
]

<br/>
<br/>
.big[Quelles conclusions peut-on faire de ces résultats ?]

---

## .orange[<i class = "fas fa-exclamation-triangle"></i>] p-value !!! 

.big[
+ Les _p-value_ dépendent de la qualité ET de la quantité des données !

+ Le seuil de 0.05 est arbitraire !

+ Les résultats des tests statistiques ne sont pas la fin de l'analyse. Il est important de prendre du recul et d'évaluer la qualité des résultats !

+ Les résultats des tests ne consituent pas des conclusions/décisions ! Ce sont des outils qui aident les experts à conclure/décider !
]

---
exclude: true
class: inverse

# Exercice 1 

Retrouver les valeurs du tableau d'analyse du jeu de données iris

---
class: inverse

# Exercice 2 

Analyse du fichier _cow.csv_ : mesure de rendement de production laitière par différentes vaches. Les vaches ont reçu soit la ration R1, soit la ration R2 de nourriture et sont à des âges différents (1ère, 2ème, 3ème ou 4ème lactation).

Existe t-il une influence de la ration et/ou de la lactation sur la production de lait ?


---
exclude: true

# Correction exercice 1

.small[
```{r}
# Groupe
i <- length(unique(iris$Species))
# Observation
n <- nrow(iris)
# Mu
mu <- pull(iris, Sepal.Length) %>% mean()
# Coef
dtalpha <- iris %>% 
  group_by(Species) %>% 
  summarize(alphas = mean(Sepal.Length) - mu)
# SS du facteur
SSF <- (n/i)*sum(pull(dtalpha, alphas)^2)
# Residu
dt <- left_join(iris, dtalpha, by = "Species") %>% 
  mutate(preds = mu + alphas) %>% 
  mutate(e = preds - Sepal.Length)
# SS residuel
SSR <- sum(pull(dt, e)^2)
# Carrée moyens
CMF <- SSF/(i - 1)
CMR <- SSR/(n - i)
# Stat de test
Fobs <- CMF/CMR
# p-value
pval <- pf(Fobs, i - 1, n - i, lower.tail = FALSE)

```
]

---
exclude: true

# Correction exercice 1

.small[
```{r}
tibble(
  Df = c(i - 1, n - i),
  SS = c(SSF, SSR),
  CM = c(CMF, CMR),
  F = c(Fobs, NA),
  p = c(pval, NA)
)
```

```{r}
mod <- lm(Sepal.Length~Species, data = iris)
anova(mod)
```


]


---

# Correction exercice 2


```{r message = FALSE, warning = FALSE}
library(readr)
library(ggplot2)
library(emmeans)
library(dplyr)
data <- read_delim(here::here("static/data/cows.csv"), delim = ";")
summary(data)
```


---

# Correction exercice 2


```{r fig.asp = 0.8}
ggplot(data) +
  aes(x = lactation, y = yield, color = ration) +
geom_point()
```



---

# Correction exercice 2


```{r}
mod <- lm(yield ~ ration + lactation + ration:lactation, data = data)
anova(mod)
```

---

# Correction exercice 2

.small[
```{r}
summary(mod)
```
] 
 
---
class: wider

.small[
 
.container-grid[
.row[
.col-5[
```{r out.width = "50%", fig.align = "center"}
plot(mod, which = 2)
```
]
.col-1[]
.col-5[
```{r out.width = "50%", fig.align = "center"}
plot(mod, which = 1)
```
]
]
.row[
.col-5[
```{r out.width = "50%", fig.align = "center"}
qplot(x = data$ration, 
      y = residuals(mod), 
      geom = "point")
```
]
.col-1[]
.col-5[
```{r out.width = "50%", fig.align = "center"}
qplot(x = data$lactation, 
      y = residuals(mod), 
      geom = "point")
```
]
]
]

]

---

# Correction exercice 2

.small[
```{r}
library(emmeans)
pairs(emmeans(mod,~ration))
```


```{r}
pairs(emmeans(mod,~lactation))
```

]

---

# Correction exercice 2

.small[
```{r}
pairs(emmeans(mod,~ration|lactation))
```

]

---

# Correction exercice 2

.small[
```{r}
pairs(emmeans(mod,~lactation|ration))
```

]
