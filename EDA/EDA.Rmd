---
title: 'Analyse exploratoire des données'
subtitle: "Faire connaissance avec ses données"
author: "Benjamin Louis"
date: "16/10/2019 (MàJ: `r format(Sys.Date(), '%d/%m/%Y')`)"
output:
  xaringan::moon_reader:
    css: [default, default-fonts, "../static/css/custom.css"]
    lib_dir: libs
    #chakra: "../libs/remark-latest.min.js"
    nature:
      highlightStyle: agate
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, echo = FALSE, warning = FALSE, message = FALSE}
htmltools::tagList(rmarkdown::html_dependency_font_awesome())
library(ggplot2)
library(tibble)
library(readr)
library(tidyr)
library(dplyr)
```

# Analyse exploratoire


+ .orange[<i class="fas fa-exclamation-triangle"></i>] __Part essentielle de toute analyse !!!__

+ .orange[<i class="fas fa-exclamation-triangle"></i>] __À effectuer en premier !!!__

.center[
<img src="../static/img/data-science.png" width="50%">
]

+ __Objectifs__ :

  + Vérifier la qualité des données (données aberrantes, manquantes, ...)
  + Vérifier le besoin de transformer les données
  + Observer la variation/covariation des données
  + Générer des questions/hypothèses sur les données

.footnote[
Image : [https://r4ds.had.co.nz/introduction.html](https://r4ds.had.co.nz/introduction.html)
]

---

# Analyse exploratoire

+ Pas de règles formelles

+ Toute question est bonne

+ Trois phases importantes :

  + Généralités sur les jeu de données
  
  + Variation des variables
  
  + Covariation des variables
  

---
class: inverse, middle, center

# Généralités sur le jeu de données

---

# Objectifs

+ Premier contact

+ Dimension du jeu de données

+ Type des variables

+ _tidy data_ ?

+ Données manquantes

+ Données avec beaucoup de 0

+ Données avec valeurs infinies

---

# Dans la console

```{r}
msleep
```

---

### `summary()`

.lesssmall[
```{r}
summary(msleep)
```
]

---
class: inverse, middle, center

# Variations

---

# Objectifs

+ Distribution des données

+ Quelles sont les valeurs les plus typiques ?

+ Quelles sont les données rares ? 

+ Données aberrantes ou juste rares ?

+ Tester la qualité des données 

---

### Variables quantitatives : histogramme .green[<i class="fas fa-thumbs-up"></i>]


```{r fig.asp = 0.8, fig.align = "center"}
ggplot(msleep) +
  aes(x = sleep_total) +
  geom_histogram(binwidth = 2, color = "white") +
  geom_freqpoly(binwidth = 2, color = "blue")
```


---

### Variables quantitatives : boxplot .orange[<i class="fas fa-exclamation-triangle"></i>]


```{r fig.asp = 0.8, fig.align = "center"}
ggplot(msleep) +
  aes(y = sleep_total) +
  geom_boxplot() +
  xlim(-1, 1)
```


---

### Variables qualitatives : barplot .green[<i class="fas fa-thumbs-up"></i>]


```{r fig.asp = 0.8, fig.align = "center"}
ggplot(msleep) +
  aes(x = vore, fill = vore) +
  geom_bar(show.legend = FALSE)
```

---

### Variables qualitatives : pie plot .red[<i class="fas fa-thumbs-down"></i>] .red[<i class="fas fa-thumbs-down"></i>] .red[<i class="fas fa-thumbs-down"></i>]


```{r echo = FALSE, fig.asp = 0.8, fig.align = "center"}
msleep %>% 
  group_by(vore) %>% 
  count() %>% 
  ggplot() +
  aes(x = "", y = n, fill = vore) +
  geom_bar(stat = "identity", width=1) +
  coord_polar("y", start = 0) +
  theme_void()
```

---
class: inverse, middle, center

# Covariations

---

# Objectifs

+ Existe t-il des relatoins entre les variables ?

+ Les relations observées sont-elles attendues ?

+ Existe t-il de l'information redondante ?

---

### Quantitative ~ Qualitative : histogrammes/freqpoly


.pull-left[
.red[<i class="fas fa-thumbs-down"></i>] Groupes de taille différente
.small[
```{r fig.asp = 0.8, fig.align = "center"}
ggplot(msleep) +
  aes(x = sleep_total, color = vore) +
  geom_freqpoly(binwidth = 4)
```
]
]

.pull-right[
.green[<i class="fas fa-thumbs-up"></i>] Comparaison densité
.small[
```{r fig.asp = 0.8, fig.align = "center"}
ggplot(msleep) +
  aes(x = sleep_total, color = vore, 
      y = ..density..) +
  geom_freqpoly(binwidth = 4)
```
]
]

---

### Quantitative ~ Qualitative : boxplot .orange[<i class="fas fa-exclamation-triangle"></i>]


```{r fig.asp = 0.8, fig.align = "center"}
ggplot(msleep) +
  aes(x = vore, y = sleep_total,
      color = vore) +
  geom_boxplot()
```

---

### Quantitative ~ Qualitative : violin plot .green[<i class="fas fa-thumbs-up"></i>]


```{r fig.asp = 0.8, fig.align = "center"}
ggplot(msleep) +
  aes(x = vore, y = sleep_total,
      color = vore) +
  geom_violin(draw_quantiles = 0.5, trim = FALSE)
```

---

### Quantitative ~ Qualitative : bar-barplot .red[<i class="fas fa-thumbs-down"></i>]

_bar-barplot_ : barplot des valeurs moyennes et écart-type

```{r echo = FALSE, fig.asp = 0.8, fig.align = "center"}
info <- msleep %>%
  group_by(vore) %>%
  summarise(Moyenne = mean(sleep_total, na.rm = TRUE),
            Ecart = sd(sleep_total, na.rm = TRUE))
ggplot(info, aes(x = vore, y = Moyenne, fill = vore)) +
  geom_bar(stat = "identity", position = position_dodge(),
           colour = "grey30") +
  geom_errorbar(
    aes(ymin = Moyenne - Ecart, ymax = Moyenne + Ecart),
    width = .2, position = position_dodge(.9), size = 1
  ) + 
  scale_y_continuous(limits = c(0, NA),
                     expand = c(0, 0)) +
  #scale_fill_viridis_d() +
  guides(fill = FALSE)
```

.footnote[
cf [https://thinkr.fr/les-pieges-de-la-representation-de-donnees/](https://thinkr.fr/les-pieges-de-la-representation-de-donnees/)
]


---

### Quantitative ~ Quantitative : scatter plot .green[<i class="fas fa-thumbs-up"></i>]


```{r fig.asp = 0.8, fig.align = "center", warning = FALSE}
ggplot(msleep) +
  aes(x = sleep_rem, y = sleep_total) +
  geom_point(size = 3)
```



---

### Qualitative ~ Qualitative : geom_count() .green[<i class="fas fa-thumbs-up"></i>]


```{r fig.asp = 0.8, fig.align = "center", warning = FALSE}
ggplot(msleep) +
  aes(x = vore, y = conservation) +
  geom_count()
```

---

### Qualitative ~ Qualitative : geom_tile() .green[<i class="fas fa-thumbs-up"></i>]


```{r fig.asp = 0.8, fig.align = "center", warning = FALSE, out.width = "50%"}
msleep %>% 
  count(vore,conservation) %>% 
  ggplot() +
  aes(x = vore, y = conservation) +
  geom_tile(aes(fill = n))
```

---
class: inverse, middle, center

# Données aberrantes

---


# Définition

+ Outliers

+ Valeurs distantes des autres observations

+ Contraste

+ Analyse exploratoire aide à les détecter

+ Des tests statistiques existent

+ Leur sort dépend uniquement de l'expertise !!!

---

## boxplot


```{r echo = FALSE, fig.align = "center", out.width = "70%", dpi = 150}
ggplot_box_legend <- function(family = "serif"){
  set.seed(100)
  sample_df <- data.frame(parameter = "test", values = sample(500))
  sample_df$values[1:100] <- 701:800
  sample_df$values[1] <- -350
  ggplot2_boxplot <- function(x){
    quartiles <- as.numeric(quantile(x, probs = c(0.25, 0.5, 0.75)))
    names(quartiles) <- c("25ème percentile", 
                          "50ème percentile\n(médiane)",
                          "75ème percentile")
    IQR <- diff(quartiles[c(1,3)])
    upper_whisker <- max(x[x < (quartiles[3] + 1.5 * IQR)])
    lower_whisker <- min(x[x > (quartiles[1] - 1.5 * IQR)])
    upper_dots <- x[x > (quartiles[3] + 1.5*IQR)]
    lower_dots <- x[x < (quartiles[1] - 1.5*IQR)]
    return(list("quartiles" = quartiles,
                "25th percentile" = as.numeric(quartiles[1]),
                "50th percentile\n(median)" = as.numeric(quartiles[2]),
                "75th percentile" = as.numeric(quartiles[3]),
                "IQR" = IQR,
                "upper_whisker" = upper_whisker,
                "lower_whisker" = lower_whisker,
                "upper_dots" = upper_dots,
                "lower_dots" = lower_dots))
  }
  ggplot_output <- ggplot2_boxplot(sample_df$values)
  update_geom_defaults("text", list(size = 3,  hjust = 0, family = family))
  update_geom_defaults("label", list(size = 3, hjust = 0, family = family))
  explain_plot <- ggplot() +
    geom_boxplot(data = sample_df, aes(x = parameter, y = values),  width = 0.3, fill = "lightgrey") +
   #○ geom_text(aes(x = 1, y = 900, label = "500"), hjust = 0.5) +
    #geom_text(aes(x = 1.17, y = 900, label = "Quantité de données"), fontface = "bold", vjust = 0.4) +
    theme_minimal(base_size = 5, base_family = family) +
    geom_segment(aes(x = 2.3, xend = 2.3, 
                     y = ggplot_output[["25th percentile"]], 
                     yend = ggplot_output[["75th percentile"]])) +
    geom_segment(aes(x = 1.2, xend = 2.3, 
                     y = ggplot_output[["25th percentile"]], 
                     yend = ggplot_output[["25th percentile"]])) +
    geom_segment(aes(x = 1.2, xend = 2.3, 
                     y = ggplot_output[["75th percentile"]], 
                     yend = ggplot_output[["75th percentile"]])) +
    geom_text(aes(x = 2.4, y = ggplot_output[["50th percentile\n(median)"]]), 
              label = "Espace interquartile", fontface = "bold",
              vjust = 0.4) +
    geom_text(aes(x = c(1.17,1.17), 
                  y = c(ggplot_output[["upper_whisker"]], ggplot_output[["lower_whisker"]]), 
                  label = c("Plus grande valeur jusqu'à 1.5 fois l'espace interquartile 
                            au-dessus du 75ème percentile",
                            "Plus petite valeur jusqu'à 1.5 fois l'espace interquartile 
                            en-dessous du 25ème percentile")), fontface = "bold", vjust = 0.9) +
    geom_text(aes(x = c(1.17),  y =  ggplot_output[["lower_dots"]],  
                  label = "Valeur considérée comme atypique (outlier)"), vjust = 0.5, fontface = "bold") +
    geom_label(aes(x = 1.17, y = ggplot_output[["quartiles"]], 
                   label = names(ggplot_output[["quartiles"]])),
               vjust = c(0.4,0.85,0.4),  fill = "white", label.size = 0) +
    ylab("") + xlab("") +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank(),
          panel.grid = element_blank(),
          aspect.ratio = 4/3,
          plot.title = element_text(hjust = 0.5, size = 10)) +
    coord_cartesian(xlim = c(1.4,2.4), ylim = c(-600, 750))
  return(explain_plot) 
}
ggplot_box_legend()
```

---

## boxplot

<i class="fas fa-arrow-circle-right"></i> Récupérer les outliers

```{r}
msleep %>% 
  filter(sleep_rem %in% boxplot.stats(sleep_rem)$out)
```

<i class="fas fa-arrow-circle-right"></i> Autres règles

Parfois on trouve des règles plus conservatrices --> $3 \times IQR$ (au lieu de 1,5)

```{r eval = FALSE}
msleep %>% 
  filter(sleep_rem %in% boxplot.stats(sleep_rem, coef = 3)$out)
```

.orange[<i class="fas fa-exclamation-triangle"></i>] Repose sur la loi normale

---

## Test de Grubbs

+ Package `outliers`

+ Test si une valeur extrême est un outlier

.small[
```{r}
library(outliers)
# Test pour valeur max
grubbs.test(msleep$sleep_rem)
# Test pour valeur min
grubbs.test(msleep$sleep_rem, opposite = TRUE)
```
]

---

# Packages utiles


<i class="fas fa-arrow-circle-right"></i> Généralités

+ `funModeling::df_status`

<i class="fas fa-arrow-circle-right"></i> Variations/Covariations

+ `xray::distributions`
+ `skimr` : [https://ropensci.github.io/skimr/](https://ropensci.github.io/skimr/)

<i class="fas fa-arrow-circle-right"></i> Transversal

+  `visdat` : [http://visdat.njtierney.com/](http://visdat.njtierney.com/)
+ `summarytools` : [https://github.com/dcomtois/summarytools](https://github.com/dcomtois/summarytools)
+ `DataExplorer` : [https://boxuancui.github.io/DataExplorer/](https://boxuancui.github.io/DataExplorer/)

---
class: inverse

# Exercice

Testez-vous sur des jeux de données de votre choix : `iris`, `mtcars`, `starwars`, ...

---

# References

+ [https://www.data-to-viz.com/](https://www.data-to-viz.com/)

+ [https://statistique-et-logiciel-r.com/comment-detecter-les-outliers-avec-r/](https://statistique-et-logiciel-r.com/comment-detecter-les-outliers-avec-r/)
